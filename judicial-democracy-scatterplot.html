<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judicial Constraints vs Democracy Level</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        .tooltip {
            position: absolute;
            padding: 10px 14px;
            background: rgba(40, 40, 40, 0.9);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 13px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            max-width: 220px;
            line-height: 1.4;
        }
        .chart-container {
            max-width: 960px;
            margin: 0 auto;
            overflow: visible;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: 600;
        }
        .axis-line {
            stroke: #ccc;
            stroke-width: 1px;
        }
        .grid line {
            stroke: #e0e0e0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }
        .domain {
            stroke: #aaa;
            stroke-width: 1.5px;
        }
        .tick text {
            font-size: 12px;
            fill: #666;
        }
        .axis-title {
            font-size: 14px;
            font-weight: 600;
            fill: #555;
        }
        .direction-indicator {
            font-weight: bold;
            font-size: 14px;
            fill: #555;
        }
        .sources {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
            line-height: 1.5;
        }
        .sources a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.2s;
        }
        .sources a:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        .data-table {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .data-table th:hover {
            background: #e9ecef;
        }
        .data-table th::after {
            content: "↕";
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }
        .data-table th.asc::after {
            content: "↑";
            opacity: 1;
        }
        .data-table th.desc::after {
            content: "↓";
            opacity: 1;
        }
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            color: #666;
        }
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        .data-table tr.israel {
            background-color: #fff9e6;
        }
        .data-table tr.israel:hover {
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>Judicial Constraints vs Democracy Level</h1>
        <div id="chart"></div>
        <div class="sources">
            Data sources: <a href="https://www.wikiwand.com/en/articles/The_Economist_Democracy_Index" target="_blank">Economist Intelligence Unit</a>, 
            <a href="https://ourworldindata.org/grapher/judicial-constraints-on-the-executive-index" target="_blank">Our World in Data</a>
        </div>
        <div id="data-table"></div>
    </div>

    <script>
        // Country name mapping to handle differences between the datasets
        const countryNameMapping = {
            // Map country names that differ between the two datasets
            "Czechia": "Czech Republic",
            "Cote d'Ivoire": "Côte d'Ivoire",
            "East Timor": "Timor-Leste",
            "Laos": "Lao PDR",
            "South Korea": "Korea, Rep.",
            "North Korea": "Korea, Dem. Rep.",
            "Eswatini": "Eswatini",
            "Congo": "Congo, Rep.",
            "Democratic Republic of Congo": "Congo, Dem. Rep.",
            "Cape Verde": "Cape Verde",
            "Turkey": "Türkiye",
            "Sao Tome and Principe": "São Tomé and Principe"
        };

        // Function to load and process the data
        async function loadData() {
            try {
                console.log("Starting to load CSV files...");
                
                // Log the files we're trying to load
                console.log("Attempting to load democracy data from:", "Untitled spreadsheet - Sheet2 (1).csv");
                console.log("Attempting to load judicial data from:", "judicial-constraints-on-the-executive-index.csv");
                
                // Load both CSV files
                const [democracyData, judicialData] = await Promise.all([
                    d3.csv("Untitled spreadsheet - Sheet2 (1).csv")
                        .catch(error => {
                            console.error("Error loading democracy data:", error);
                            document.getElementById("chart").innerHTML = 
                                "<p>Error loading democracy data from 'Untitled spreadsheet - Sheet2 (1).csv'. " +
                                "Please make sure the file exists in the same directory.</p>";
                            return [];
                        }),
                    d3.csv("judicial-constraints-on-the-executive-index.csv")
                        .catch(error => {
                            console.error("Error loading judicial data:", error);
                            document.getElementById("chart").innerHTML = 
                                "<p>Error loading judicial constraints data from 'judicial-constraints-on-the-executive-index.csv'. " +
                                "Please make sure the file exists in the same directory.</p>";
                            return [];
                        })
                ]);
                
                console.log("CSV loading complete. Democracy data rows:", democracyData.length);
                console.log("CSV loading complete. Judicial data rows:", judicialData.length);
                
                if (!democracyData.length || !judicialData.length) {
                    throw new Error("One or both datasets are empty");
                }

                // Process democracy data
                const processedDemocracyData = democracyData.map(d => {
                    return {
                        country: d.countryname,
                        democracyIndex: parseFloat(d["Democracy index"])
                    };
                }).filter(d => !isNaN(d.democracyIndex));

                // Create a merged dataset
                const mergedData = [];
                
                judicialData.forEach(jd => {
                    const judicialConstraint = parseFloat(jd["Judicial constraints on the executive index (best estimate)"]);
                    
                    // Try to find a match in the democracy data
                    let countryName = jd.Entity;
                    // Check if the country name needs to be mapped
                    const mappedName = countryNameMapping[countryName];
                    
                    // Try with original name first, then with mapped name if available
                    let democracyMatch = processedDemocracyData.find(d => d.country === countryName);
                    
                    if (!democracyMatch && mappedName) {
                        democracyMatch = processedDemocracyData.find(d => d.country === mappedName);
                    }
                    
                    if (democracyMatch) {
                        mergedData.push({
                            country: countryName,
                            judicialConstraint: judicialConstraint,
                            democracyIndex: democracyMatch.democracyIndex
                        });
                    }
                });

                return mergedData;
            } catch (error) {
                console.error("Error loading or processing data:", error);
                document.getElementById("chart").innerHTML = "<p>Error loading data. Please make sure the CSV files exist.</p>";
                return [];
            }
        }

        // Create the scatterplot
        loadData().then(data => {
            if (data.length === 0) return;
            
            // Set up the SVG dimensions
            const margin = {top: 40, right: 100, bottom: 60, left: 80};
            const width = 800 - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom;

            // Create the SVG element
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Add a subtle background rectangle
            svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .attr("fill", "#f8f9fa")
                .attr("rx", 6); // rounded corners

            // Set up scales
            const xScale = d3.scaleLinear()
                .domain([0, 1])  // Judicial constraints are between 0 and 1
                .range([0, width])
                .nice();

            const yScale = d3.scaleLinear()
                .domain([0, 10])  // Democracy index is between 0 and 10
                .range([height, 0])
                .nice();

            // Add grid lines
            // Vertical grid lines
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickSize(-height)
                    .tickFormat("")
                );

            // Horizontal grid lines
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                );

            // Add axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .attr("class", "axis-line")
                .append("text")
                .attr("x", width / 2)
                .attr("y", 45)
                .attr("fill", "#2c3e50")
                .attr("font-size", "14px")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
                .attr("class", "axis-title")
                .text("Judicial Constraints on the Executive");

            svg.append("g")
                .call(d3.axisLeft(yScale))
                .attr("class", "axis-line")
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -60)
                .attr("x", -height / 2)
                .attr("fill", "#2c3e50")
                .attr("font-size", "14px")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
                .attr("class", "axis-title")
                .text("Democracy Level");

            // Add directional indicators for axes
            // For X-axis (Judicial Constraints)
            svg.append("text")
                .attr("x", width - 10)
                .attr("y", height - 10)  // Moved above X axis
                .attr("text-anchor", "end")
                .attr("class", "direction-indicator")
                .text("More Judicial Constraints →");

            // For Y-axis (Democracy Level)
            svg.append("text")
                .attr("y", 15)
                .attr("x", 10)  // Moved much closer to Y axis, still on right
                .attr("text-anchor", "start")
                .attr("class", "direction-indicator")
                .text("More Democratic ↑");

            // Create a tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Add data points - use a better color scheme
            svg.selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", d => xScale(d.judicialConstraint))
                .attr("cy", d => yScale(d.democracyIndex))
                .attr("r", d => d.country === "Israel" ? 9 : 6)
                .attr("fill", d => d.country === "Israel" ? "#ffc107" : "#3498db") // Better colors
                .attr("stroke", d => d.country === "Israel" ? "#e67e22" : "#2980b9")
                .attr("stroke-width", d => d.country === "Israel" ? 3 : 1)
                .attr("opacity", 0.85)
                .style("filter", "drop-shadow(0px 1px 2px rgba(0,0,0,0.1))")
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", d.country === "Israel" ? 11 : 8)
                        .attr("stroke-width", d.country === "Israel" ? 4 : 2)
                        .attr("opacity", 1);

                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .95);
                    
                    let tooltipText = `<strong>${d.country}</strong><br>`;
                    tooltipText += `Democracy Index: <strong>${d.democracyIndex.toFixed(2)}</strong><br>`;
                    tooltipText += `Judicial Constraints: <strong>${d.judicialConstraint.toFixed(2)}</strong>`;
                    
                    tooltip.html(tooltipText)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr("r", d.country === "Israel" ? 9 : 6)
                        .attr("stroke-width", d.country === "Israel" ? 3 : 1)
                        .attr("opacity", 0.85);
                    
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Create and populate the data table
            let currentSortColumn = null;
            let currentSortOrder = "asc";
            
            function renderTable(sortedData) {
                // Clear existing table
                d3.select("#data-table").html("");
                
                const table = d3.select("#data-table")
                    .append("table")
                    .attr("class", "data-table");
                
                // Add table header
                const thead = table.append("thead").append("tr");
                
                const columns = ["Country", "Democracy Index", "Judicial Constraints"];
                
                thead.selectAll("th")
                    .data(columns)
                    .enter()
                    .append("th")
                    .text(d => d)
                    .attr("class", d => {
                        if (d === currentSortColumn) {
                            return currentSortOrder;
                        }
                        return "";
                    })
                    .on("click", function(event, d) {
                        if (d === currentSortColumn) {
                            currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
                        } else {
                            currentSortColumn = d;
                            currentSortOrder = "asc";
                        }
                        
                        // Sort the data
                        const sorted = [...data].sort((a, b) => {
                            let aVal, bVal;
                            
                            switch(d) {
                                case "Country":
                                    aVal = a.country;
                                    bVal = b.country;
                                    break;
                                case "Democracy Index":
                                    aVal = a.democracyIndex;
                                    bVal = b.democracyIndex;
                                    break;
                                case "Judicial Constraints":
                                    aVal = a.judicialConstraint;
                                    bVal = b.judicialConstraint;
                                    break;
                            }
                            
                            if (currentSortOrder === "asc") {
                                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                            } else {
                                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                            }
                        });
                        
                        renderTable(sorted);
                    });
                
                // Add table body
                const tbody = table.append("tbody");
                
                // Add table rows
                tbody.selectAll("tr")
                    .data(sortedData)
                    .enter()
                    .append("tr")
                    .attr("class", d => d.country === "Israel" ? "israel" : "")
                    .selectAll("td")
                    .data(d => [
                        d.country,
                        d.democracyIndex.toFixed(2),
                        d.judicialConstraint.toFixed(2)
                    ])
                    .enter()
                    .append("td")
                    .text(d => d);
            }
            
            // Initial table render
            renderTable(data);

            // Add a subtle border to the chart area
            svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .attr("fill", "none")
                .attr("stroke", "#ddd")
                .attr("stroke-width", 1)
                .attr("rx", 6)
                .attr("pointer-events", "none");

        }).catch(error => {
            console.error("Error creating chart:", error);
            document.getElementById("chart").innerHTML = "<p>Error creating chart. Please check the console for details.</p>";
        });
    </script>
</body>
</html> 